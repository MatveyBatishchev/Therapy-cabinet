<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="ru.mospolytech.therapy_cabinet.mybatis.mappers.PrescriptionMapper">

    <!--maps-->
    <resultMap id="PrescriptionReadMap" type="ru.mospolytech.therapy_cabinet.models.domain.prescription.PrescriptionRead">
        <id column="id" property="id"/>
        <result column="value" property="value"/>
        <result column="dose_amount" property="doseAmount"/>
        <result column="substance_amount" property="substanceAmount"/>
        <result column="administration_type" property="administrationType"/>
        <result column="comments" property="comments"/>
        <association columnPrefix="therapy_" property="therapy"
                     javaType="ru.mospolytech.therapy_cabinet.models.domain.therapy.TherapyCreate"
                     resultMap="ru.mospolytech.therapy_cabinet.mybatis.mappers.TherapyMapper.TherapyCreateMap"/>
        <association columnPrefix="medication_" property="medication"
                     javaType="ru.mospolytech.therapy_cabinet.models.domain.Medication"
                     resultMap="ru.mospolytech.therapy_cabinet.mybatis.mappers.MedicationMapper.MedicationMap"/>
    </resultMap>

    <resultMap id="PrescriptionCreateMap" type="ru.mospolytech.therapy_cabinet.models.domain.prescription.PrescriptionCreate">
        <id column="id" property="id"/>
        <result column="value" property="value"/>
        <result column="dose_amount" property="doseAmount"/>
        <result column="substance_amount" property="substanceAmount"/>
        <result column="administration_type" property="administrationType"/>
        <result column="comments" property="comments"/>
        <result column="therapy_id" property="therapyId"/>
        <result column="medication_id" property="medicationId"/>
    </resultMap>

    <!--queries-->
    <insert id="create" parameterType="map">
        insert into doc.prescription (id, therapy_id, medication_id, dose_amount, substance_amount, administration_type, comments)
        values (#{prescription.id}, #{prescription.therapyId}, #{prescription.medicationId}, #{prescription.doseAmount},
                #{prescription.substanceAmount}, #{prescription.administrationType.code}, #{prescription.comments});
    </insert>

    <select id="readByTherapyId" parameterType="map" resultMap="PrescriptionReadMap">
        select prescription.id           as id,
               medication_id,
               dose_amount,
               substance_amount,
               administration_type,
               prescription.comments     as comments,
               therapy.id                as therapy_id,
               therapy.date              as therapy_date,
               therapy.time_period       as therapy_time_period,
               therapy.status            as therapy_status,
               therapy.comments          as therapy_comments,
               therapy.patient_id        as therapy_patient_id,
               medication.id             as medication_id,
               medication.nomenclature   as medication_nomenclature,
               medication.manufacturer   as medication_manufacturer,
               medication.dose_form      as medication_dose_form,
               medication.dose_val       as medication_dose_val,
               medication.mu             as medication_mu
        from doc.prescription
                 left join doc.therapy therapy on therapy.id = prescription.therapy_id
                 left join doc.medication medication on medication.id = prescription.medication_id
        where prescription.therapy_id = #{therapyId};
    </select>

    <update id="updateByTherapyId" parameterType="map">
        update doc.prescription
        set
        <if test="prescription.medicationId != null">medication_id = #{prescription.medicationId},</if>
        <if test="prescription.doseAmount != null">dose_amount = #{prescription.doseAmount},</if>
        <if test="prescription.substanceAmount != null">substance_amount = #{prescription.substanceAmount},</if>
        <if test="prescription.comments != null">comments = #{prescription.comments},</if>
        <if test="prescription.administrationType != null">administration_type = #{prescription.administrationType.code},</if>
        -- FIXME: changed field set to now() even if nothing changed
        changed = now()
        where therapy_id = #{therapyId};
    </update>

    <delete id="deleteByTherapyId" parameterType="map">
        delete
        from doc.prescription
        where therapy_id = #{therapyId};
    </delete>

    <select id="readAll" parameterType="map" resultMap="PrescriptionCreateMap">
        select id,
               therapy_id,
               medication_id,
               dose_amount,
               substance_amount,
               administration_type
        from doc.prescription
        limit #{limit} offset #{offset};
    </select>
</mapper>